# work-go-movies
## ■履歴
#### 2016/10/29 v0.1 内部公開版完成（CRUDはREAD(全件)のみ対応）
## ■概要
#### 動画リソースに関する項目を扱うWebAPI
#### 以前 PHP+jQuery で自分の親向けに簡易的に作っていた「子どもの動画共有サイト」のリプレース用に作成。
#### 下記と組み合わせて、とりあえずリプレースは完了。
#### https://github.com/sky0621/work-front-movies
#### 　・・・ブラウザからアクセスする際のフロントビュー用に用意。
#### https://github.com/sky0621/work-go-movieconverter
#### 　・・・動画をFTPしたら、あとは勝手にWeb公開まで持っていきたかったので ffmpeg/ImageMagick 叩いてよしなに公開パスまで持っていくツールを用意。
#### GRPC使ってみたくて下記のような構成にしたけど、それ以外の部分は最短でリプレース完了・再公開に至れるように進めた。（ので、テストコードもなく、動作確認もザル。）
## ■構成
### ▽client = WebAPI
#### 　実クライアントからのCRUD要求に応じて、server にリクエストし、結果を編集してクライアントに返す。
#### 　返却形式はJSON。ユーザがアクセスするフロントビューは別プロジェクト（※）として作る。
#### 　※ https://github.com/sky0621/work-front-movies
### ▽server
#### 　リクエストに応じた動画リソース項目を persistence から取得し、client に提供する。
### ▽persistence = 永続化層
#### 　server からのCRUD要求に応じて動画リソース項目を永続化ストレージを使って生成・更新・取得・削除する。
##### 　自前用ではファイル名と撮影日時のみあればよいのと、新規追加していくくらいの用途しかないので、現状はJSONで管理。
### ▽update
##### 　永続ストレージ（現状はJSON）最新化ツール
## ■自前構築事例
#### 適当にサーバ用意。
#### client、server、persistenceそれぞれビルドした実行ファイルを、OSの仕組み使ってデーモン化。
#### ※上記モジュールは client - server 間、 server - persistence 間をGRPC使って接続する関係。
#### ※client はGRPC接続とは別でフロントからの要求に応じるため、HTTP接続用に適当なポートで待ち受け。
#### Nginxたてて、公開ディレクトリにフロントビュー用の別プロジェクトの中身を展開。そこからの接続はNginxでリバプロして、client に飛ばす。
#### ＜その他＞
#### persistence が取得する動画情報は json で保持していて、公開したい動画をFTPしたら勝手に json に追加するよう、下記の仕組みを別途用意。
#### update をビルドした実行ファイルを、OSの仕組み使ってデーモン化。
#### これにより指定のパスにある追加用のファイルを定期的にウォッチして json に足しこむようになる。
#### 　
#### 追加用のファイル作成モジュールは下記。
#### （https://github.com/sky0621/work-go-movieconverter）
#### 上記をビルドした実行ファイルを、OSの仕組みを使ってデーモン化。
#### これにより指定のパスにファイルをアップしたら、動画の容量をWeb公開に耐えうるレベルに落とし、動画からサムネイルも作成し、Web公開用ディレクトリに移動。
#### 元動画は（OSのストレージを圧迫するので）削除。
#### ※上記の通り、ffmpeg/ImageMagickがインストールされていることは前提。
#### ※AndroidOS（ないし特定の端末）で作成した動画の場合、サムネイル切り出すとローテートが９０度傾いているので、ImageMagickでローテートを行う。
## ■今後の構想
#### ・とりあえずテストコード書く。
#### ・プログラム引数を設定ファイル（ないし、必要に応じて環境変数）から取得するようにする。
#### ・永続化方法をDBに変える（ないし、選択可能）にする。
#### ・シグナル受信してゴルーチン止めるロジック入れる。（今は、それすら入ってない）
#### ・APIキーの扱いを考える。（Androidアプリ作ったら利用かな。）
#### ・プログラム引数のバリデーションロジックを書く。
#### ・loggerについて、よいモジュールがあれば採用して置き換える。
#### ・CRUDのREAD以外の機能も実装する。
#### ・clientについて、Webフレームワークを採用して置き換える。（軽量なものから）
#### ・アプリのバージョンを管理する。
